if not game:IsLoaded() then game.Loaded:Wait() end

local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer or Players.PlayerAdded:Wait()
local playerGui = player:WaitForChild("PlayerGui")

-- [[ CONFIGURATION ]]
local CHANNEL_ID = "1426479580784361482"
local TOKEN_URL = "https://prpjectlol-default-rtdb.firebaseio.com/token.json"
local SCAN_DELAY = 0.5 
local ALERT_SOUND_ID = "rbxassetid://5476307813"

local Whitelist = {
    "skibidi toilet", "festive 67", "los primos", "dragon cannelloni", 
    "meowl", "strawberry elephant", "spooky and pumpky",
    "la secret combinasion", "cooki and milki", "ketupat kepat",
    "reinito sleighito", "burguro and fryuro",
    "garama and madundung", "la ginger sekolah", "la taco combinasion",
    "fragrama and chocrama", "dragon gingerini", "la casa boo",
    "ketchuru and musturu", "capitano moby", "lavadorito spinito"
}

local LogHistory = {}
local DISCORD_TOKEN = ""

-- [[ UI: TOP NOTIFICATION ]]
local function ShowTopMessage(petName, value, jid)
    local sg = Instance.new("ScreenGui", playerGui)
    sg.Name = "PriorityAlert"
    sg.ResetOnSpawn = false

    local frame = Instance.new("TextButton", sg)
    frame.Size = UDim2.new(0, 350, 0, 75)
    frame.Position = UDim2.new(0.5, -175, -0.2, 0) 
    frame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    frame.BorderSizePixel = 0
    frame.Text = "" 
    Instance.new("UICorner", frame)
    
    local stroke = Instance.new("UIStroke", frame)
    stroke.Color = Color3.fromRGB(255, 50, 50) -- Red for high priority/spam state
    stroke.Thickness = 3

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0.4, 0)
    title.Text = "üî• PRIORITY TARGET DETECTED"
    title.TextColor3 = Color3.fromRGB(255, 50, 50)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 13 
    title.BackgroundTransparency = 1

    local desc = Instance.new("TextLabel", frame)
    desc.Size = UDim2.new(0.9, 0, 0.4, 0)
    desc.Position = UDim2.new(0.05, 0, 0.45, 0)
    desc.Text = petName:upper() .. " | VALUE: " .. tostring(value) .. "M"
    desc.TextColor3 = Color3.new(1, 1, 1)
    desc.Font = Enum.Font.GothamMedium
    desc.TextScaled = true 
    desc.BackgroundTransparency = 1
    
    Instance.new("UITextSizeConstraint", desc).MaxTextSize = 16

    local isSpamming = false
    frame.MouseButton1Click:Connect(function()
        if isSpamming then return end
        isSpamming = true
        
        -- UI Visual Feedback for Spamming
        title.Text = "‚ö†Ô∏è SPAMMING JOIN..."
        title.TextColor3 = Color3.fromRGB(255, 255, 0)
        stroke.Color = Color3.fromRGB(255, 255, 0)

        task.spawn(function()
            -- Attempt to join 60 times (roughly 30 seconds of spamming)
            for i = 1, 60 do
                if not frame or not frame.Parent then break end
                pcall(function() 
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, jid, player) 
                end)
                task.wait(0.5)
            end
            isSpamming = false
            if title then title.Text = "DONE SPAMMING" end
        end)
    end)

    frame:TweenPosition(UDim2.new(0.5, -175, 0.05, 0), "Out", "Back", 0.5)
    
    -- Auto-remove if not clicked within 15 seconds
    task.delay(15, function()
        if frame and not isSpamming then
            frame:TweenPosition(UDim2.new(0.5, -175, -0.2, 0), "In", "Quad", 0.5)
            task.wait(0.5)
            sg:Destroy()
        end
    end)
end

-- [[ SCANNER ]]
task.spawn(function()
    local requestFunc = request or http_request or (http and http.request) or (syn and syn.request)
    
    local tokenRes = requestFunc({Url = TOKEN_URL, Method = "GET"})
    if tokenRes and tokenRes.StatusCode == 200 then
        DISCORD_TOKEN = HttpService:JSONDecode(tokenRes.Body)
    else
        warn("Token failed to load.")
        return
    end

    while true do
        pcall(function()
            local res = requestFunc({
                Url = "https://discord.com/api/v9/channels/" .. CHANNEL_ID .. "/messages?limit=5",
                Method = "GET",
                Headers = { ["Authorization"] = DISCORD_TOKEN }
            })

            if res and res.StatusCode == 200 then
                local messages = HttpService:JSONDecode(res.Body)
                for i = #messages, 1, -1 do
                    local msg = messages[i]
                    if msg and not LogHistory[msg.id] then
                        LogHistory[msg.id] = true
                        
                        local blob = (msg.content or "")
                        if msg.embeds then
                            for _, em in pairs(msg.embeds) do
                                blob = blob .. " " .. (em.title or "") .. " " .. (em.description or "")
                                if em.fields then for _, v in pairs(em.fields) do blob = blob .. " " .. (v.name or "") .. " " .. (v.value or "") end end
                            end
                        end

                        local jid = blob:match("[%w%-]+%-%w+%-%w+%-%w+%-%w+")
                        
                        -- Value/RAP Extraction
                        local rawValue = blob:match("Value:[%s%*]*(%d+%.?%d*)") or blob:match("(%d+%.?%d*)[MmSs]")
                        local val = tonumber(rawValue) or 0
                        
                        local foundPriority = nil
                        for _, w in pairs(Whitelist) do
                            if string.find(blob:lower(), w:lower(), 1, true) then
                                foundPriority = w
                                break
                            end
                        end

                        if foundPriority and jid then
                            ShowTopMessage(foundPriority, val, jid)
                            local s = Instance.new("Sound", game:GetService("SoundService"))
                            s.SoundId = ALERT_SOUND_ID
                            s:Play(); Debris:AddItem(s, 5)
                         end
                    end
                end
            end
        end)
        task.wait(SCAN_DELAY)
    end
end)
